"use strict";var dateStart=moment().subtract(7,"days").format("YYYY-MM-DD"),dateEnd=moment().subtract(1,"days").format("YYYY-MM-DD"),audienceOverview=$("#audience-overview"),audienceOverviewRangePicker=$("#audience-overview-rangepicker"),selectedAudienceOverview=null,audienceOverviewCategories=null,audienceOverviewSeries=null,devicesReport=$("#devices-report"),devicesReportRangePicker=$("#devices-report-rangepicker"),realtimeReportactiveUsersCount=$("#active-users-count"),realtimeReportActiveScreen=$("#realtime-report-active-screen"),realtimeReportActiveScreenList="",activeUsersTrending=$("#active-users-trending"),activeUsersTrendingChart=$("#active-users-trending-chart"),activeUsersTrendingRangePicker=$("#active-users-trending-rangepicker"),activeUsersTrendingMonthly=$(".active-users-trending-monthly"),activeUsersTrendingWeekly=$(".active-users-trending-weekly"),activeUsersTrendingDaily=$(".active-users-trending-daily"),appVersionsReport=$("#app-versions-report"),appVersionsReportChart=$("#app-versions-report-chart"),appVersionsReportRangePicker=$("#app-versions-report-rangepicker"),locationOverview=$("#location-overview"),locationOverviewMap=$("#location-overview-map"),locationOverviewChart=$("#location-overview-chart"),locationOverviewRangePicker=$("#location-overview-rangepicker"),screensReport=$("#screens-report"),screensReportRangePicker=$("#screens-report-rangepicker"),cohortAnalysisReport=$("#cohort-analysis-report"),cohortAnalysisReportChart=$("#cohort-analysis-report-chart"),cohortAnalysisReportRangePicker=$("#cohort-analysis-report-rangepicker"),Analytic={init:function(){Analytic.main(),Analytic.fetchAudienceOverview(dateStart,dateEnd),Analytic.fetchDevicesReport(dateStart,dateEnd),Analytic.fetchRealtimeReport(),Analytic.fetchActiveUsersTrending(dateStart,dateEnd),Analytic.fetchLocationOverview(dateStart,dateEnd),Analytic.fetchScreensReport(dateStart,dateEnd),Analytic.fetchCohortAnalysisReport(dateStart,dateEnd)},main:function(){$(".rangepicker").daterangepicker({drops:"up",buttonClasses:"btn",applyClass:"btn-primary",cancelClass:"btn-default",format:"YYYY/MM/DD",startDate:moment().subtract(7,"days"),endDate:moment().subtract(1,"days"),ranges:{Today:[moment(),moment()],Yesterday:[moment().subtract(1,"days"),moment()],"Last 7 Days":[moment().subtract(7,"days"),moment().subtract(1,"days")],"Last 30 Days":[moment().subtract(30,"days"),moment().subtract(1,"days")],"This Month":[moment().startOf("month"),moment().endOf("month")],"Last Month":[moment().subtract(1,"month").startOf("month"),moment().subtract(1,"month").endOf("month")]}}),$(".cohort-rangepicker").daterangepicker({drops:"up",buttonClasses:"btn",applyClass:"btn-primary",cancelClass:"btn-default",format:"YYYY/MM/DD",startDate:moment().subtract(7,"days"),endDate:moment().subtract(1,"days"),showCustomRangeLabel:!1,autoApply:!0,ranges:{"Last 7 Days":[moment().subtract(7,"days"),moment().subtract(1,"days")],"Last 3 Weeks":[moment().subtract(3,"weeks").startOf("week"),moment().subtract(1,"weeks").endOf("week")],"Last 6 Weeks":[moment().subtract(6,"weeks").startOf("week"),moment().subtract(1,"weeks").endOf("week")],"Last 3 Months":[moment().subtract(3,"month").startOf("month"),moment().subtract(1,"month").endOf("month")]}}),audienceOverviewRangePicker.on("apply.daterangepicker",function(e,t){$(this).find("span").text(t.chosenLabel),Analytic.fetchAudienceOverview(t.startDate.format("YYYY-MM-DD"),t.endDate.format("YYYY-MM-DD"))}),$(document).on("click",".audience-overview-tab",function(){audienceOverviewCategories=$(this).find("a").data("categories"),audienceOverviewSeries=$(this).find("a").data("series"),Analytic.loadAudienceOverview(audienceOverviewCategories,audienceOverviewSeries)}),devicesReportRangePicker.on("apply.daterangepicker",function(e,t){$(this).find("span").text(t.chosenLabel),Analytic.fetchDevicesReport(t.startDate.format("YYYY-MM-DD"),t.endDate.format("YYYY-MM-DD"))}),activeUsersTrendingRangePicker.on("apply.daterangepicker",function(e,t){$(this).find("span").text(t.chosenLabel),Analytic.fetchActiveUsersTrending(t.startDate.format("YYYY-MM-DD"),t.endDate.format("YYYY-MM-DD"))}),appVersionsReportRangePicker.on("apply.daterangepicker",function(e,t){$(this).find("span").text(t.chosenLabel),Analytic.fetchAppVersionsReport(t.startDate.format("YYYY-MM-DD"),t.endDate.format("YYYY-MM-DD"))}),locationOverviewRangePicker.on("apply.daterangepicker",function(e,t){$(this).find("span").text(t.chosenLabel),Analytic.fetchLocationOverview(t.startDate.format("YYYY-MM-DD"),t.endDate.format("YYYY-MM-DD"))}),screensReportRangePicker.on("apply.daterangepicker",function(e,t){$(this).find("span").text(t.chosenLabel),Analytic.fetchScreensReport(t.startDate.format("YYYY-MM-DD"),t.endDate.format("YYYY-MM-DD"))}),cohortAnalysisReportRangePicker.on("apply.daterangepicker",function(e,t){$(this).find("span").text(t.chosenLabel);var n=t.startDate,r=t.endDate,a=n.diff(r,"days");Analytic.fetchCohortAnalysisReport(t.startDate.format("YYYY-MM-DD"),t.endDate.format("YYYY-MM-DD"),Math.abs(a))})},fetchAudienceOverview:function(e,t){App.blockElement(audienceOverview),App.ajax(App.baseUrl("analytic/getAudienceOverview"),"get","json",{start:e,end:t}).error(function(e){}).done(function(e){App.unblockElement(audienceOverview),audienceOverview.find(".card-body").html(e),selectedAudienceOverview=audienceOverview.find("li.active"),audienceOverviewCategories=selectedAudienceOverview.find("a").data("categories"),audienceOverviewSeries=selectedAudienceOverview.find("a").data("series"),Analytic.loadAudienceOverview(audienceOverviewCategories,audienceOverviewSeries)})},loadAudienceOverview:function(e,t){Highcharts.chart("audience-overview-chart",{chart:{type:"line"},title:{text:null},xAxis:{categories:e,labels:{formatter:function(){return moment(this.value).format("D MMM")}}},yAxis:{title:{text:null},labels:{enabled:!1}},tooltip:{shared:!0},credits:{enabled:!1},series:t})},fetchDevicesReport:function(e,t){App.blockElement(devicesReport),App.ajax(App.baseUrl("analytic/getDevicesReport"),"get","json",{start:e,end:t}).error(function(e){}).done(function(e){App.unblockElement(devicesReport),devicesReport.find(".card-body").html(e)})},fetchRealtimeReport:function(){App.ajax(App.baseUrl("analytic/getRealtimeReport"),"get","json",null).error(function(e){}).done(function(e){realtimeReportactiveUsersCount.text(e.activeUsers),Highcharts.chart("realtime-report-screen-chart",{chart:{type:"column",backgroundColor:null},title:{text:null},legend:{enabled:!1},credits:{enabled:!1},xAxis:{gridLineWidth:0,tickWidth:0,lineWidth:0,labels:{enabled:!1}},yAxis:{gridLineWidth:0,minorGridLineWidth:0,maxPadding:.2,title:{text:null},labels:{enabled:!1}},series:e.screenViews,tooltip:{formatter:function(){return"<div>                                    <span>"+(this.series.data.length-this.series.data.indexOf(this.point)+" mins ago")+'<span>                                    <h2 class="overview-count">'+this.point.y+"</h2>                                    <span>Screen Views</span>                                </div>"},useHTML:!0}}),realtimeReportActiveScreenList="",realtimeReportActiveScreen.find("tbody").empty(),$.each(e.screenName,function(e,t){realtimeReportActiveScreenList+="<tr><td>"+t[0]+'</td><td class="text-right">'+t[1]+"</td></tr>"}),e.screenName?realtimeReportActiveScreen.find("tbody").append(realtimeReportActiveScreenList):realtimeReportActiveScreen.find("tbody").append('<tr><td class="text-center" colspan="2">No data</td></tr>'),setTimeout(Analytic.fetchRealtimeReport,3e4)})},fetchActiveUsersTrending:function(e,t){App.blockElement(activeUsersTrending),App.ajax(App.baseUrl("analytic/getActiveUsersTrending"),"get","json",{start:e,end:t}).error(function(e){}).done(function(e){App.unblockElement(activeUsersTrending),activeUsersTrendingMonthly.text(e.current.Monthly),activeUsersTrendingWeekly.text(e.current.Weekly),activeUsersTrendingDaily.text(e.current.Daily),Analytic.loadActiveUsersTrending(e.categories,e.series)})},loadActiveUsersTrending:function(e,t){Highcharts.chart("active-users-trending-chart",{chart:{type:"line"},title:{text:null},xAxis:{categories:e,labels:{formatter:function(){return moment(this.value).format("D MMM")}}},legend:{enabled:!1},yAxis:{title:{text:null},labels:{enabled:!1}},tooltip:{formatter:function(){var e="<div><span>"+moment(this.x).format("ddd D MMM")+"<span><br><br>";return this.points.reverse(),$.each(this.points,function(){e+="<span>"+this.series.name+'</span><h2 class="tooltip-overview-count">'+this.point.y+"</h2>"}),e+="</div>"},useHTML:!0,shared:!0},credits:{enabled:!1},series:t})},fetchAppVersionsReport:function(e,t){App.blockElement(appVersionsReport),App.ajax(App.baseUrl("analytic/getAppVersionsReport"),"get","json",{start:e,end:t}).error(function(e){}).done(function(e){App.unblockElement(appVersionsReport),Analytic.loadAppVersionsReport(e.categories,e.series)})},loadAppVersionsReport:function(e,t){Highcharts.chart("app-versions-report-chart",{chart:{type:"column"},title:{text:null},xAxis:{categories:e,labels:{formatter:function(){return moment(this.value).format("D MMM")}}},legend:{enabled:!0},yAxis:{title:{text:null},labels:{enabled:!1}},tooltip:{formatter:function(){var e="<div><span>"+moment(this.x).format("ddd D MMM")+"<span><br><br>";return this.points.reverse(),$.each(this.points,function(){e+="<span>"+this.series.name+'</span><h2 class="tooltip-overview-count">'+this.point.y+"</h2>"}),e+="</div>"},useHTML:!0,shared:!0},credits:{enabled:!1},plotOptions:{series:{stacking:"normal",borderColor:"transparent"}},colors:["#03a9f4","#35baf6","#67cbf8","#9adcfa","#ccedfc","#0298db","#0287c3","#0276aa","#016592","#01547a","#014361"],series:t})},fetchLocationOverview:function(e,t){App.blockElement(locationOverview),App.ajax(App.baseUrl("analytic/getLocationOverview"),"get","json",{start:e,end:t}).error(function(e){}).done(function(e){App.unblockElement(locationOverview),Analytic.loadLocationOverview(e.regions,e.categories,e.series,e.count)})},loadLocationOverview:function(e,t,n,r){locationOverviewMap.empty(),locationOverviewMap.vectorMap({map:"world_en",backgroundColor:null,color:"#eee",borderColor:"#eee",hoverOpacity:1,selectedColor:"#4caf50",enableZoom:!0,showTooltip:!0,normalizeFunction:"polynomial",selectedRegions:e,onRegionClick:function(e){console.log(e),e.preventDefault()}}),Highcharts.chart("location-overview-chart",{chart:{type:"bar"},title:{text:null},credits:{enabled:!1},legend:{enabled:!1},plotOptions:{series:{shadow:!1,borderWidth:0,dataLabels:{enabled:!0,formatter:function(){var e=this.y/r*100;return Highcharts.numberFormat(e)+"%"}}}},xAxis:{tickWidth:0,lineWidth:0,labels:{enabled:!1}},yAxis:{maxPadding:.1,title:{text:null},labels:{formatter:function(){var e=this.value/r*100;return Highcharts.numberFormat(e,0,",")+"%"}}},tooltip:{formatter:function(){return"<div>                            <span>"+this.series.name+'<span>                            <h2 class="overview-count">'+this.point.y+"</h2>                            <span>Sessions</span>                        </div>"},useHTML:!0},colors:["#4caf50","#449d48","#3c8c40","#357a38","#2d6930","#265728","#1e4620","#163418"],series:n})},fetchScreensReport:function(e,t){App.blockElement(screensReport),App.ajax(App.baseUrl("analytic/getScreensReport"),"get","json",{start:e,end:t}).error(function(e){}).done(function(e){App.unblockElement(screensReport),screensReport.find(".card-body").html(e)})},fetchCohortAnalysisReport:function(e,t,n){App.blockElement(cohortAnalysisReport),App.ajax(App.baseUrl("analytic/getCohortAnalysisReport"),"get","json",{start:e,end:t,difference:n}).error(function(e){}).done(function(e){App.unblockElement(cohortAnalysisReport),cohortAnalysisReport.find(".card-body").html(e),Array.max=function(e){return Math.max.apply(Math,e)};var t=$(".user-retention").map(function(){return parseInt($(this).text())}).get(),n=Array.max(t);$(".user-retention").each(function(){var e=parseInt($(this).text()),t=parseInt(Math.round(e/n*100).toFixed(0)),r="rgb("+parseInt((255+-204*t/99).toFixed(0))+","+parseInt((255+-152*t/99).toFixed(0))+","+parseInt((255+-41*t/99).toFixed(0))+")",a="rgb(220,220,220)";$(this).css({background:r,color:r}),0==$(this).text()&&$(this).css({background:a,color:a})}),$('[data-toggle="popover"]').popover()})},loadCohortAnalysisReport:function(e){var t=moment("2017-08-03").toDate(),n=document.getElementById("cohort-analysis-report-chart");Cornelius.draw({initialDate:t,container:n,cohort:e,title:null,timeInterval:"daily",rawNumberOnHover:!0,displayAbsoluteValues:!0,labels:{people:"Active Users",time:"Period"},formatHeaderLabel:function(e){return"Day "+--e}})}};